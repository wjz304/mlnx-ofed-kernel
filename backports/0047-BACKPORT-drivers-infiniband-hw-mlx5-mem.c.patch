From: Valentine Fatiev <valentinef@nvidia.com>
Subject: [PATCH] BACKPORT: drivers/infiniband/hw/mlx5/mem.c

Change-Id: I090fcd82dc79f4785284bff619c4eb8448703ec9
---
 drivers/infiniband/hw/mlx5/mem.c | 7 +++++++
 1 file changed, 7 insertions(+)

--- a/drivers/infiniband/hw/mlx5/mem.c
+++ b/drivers/infiniband/hw/mlx5/mem.c
@@ -33,6 +33,7 @@
 #include <rdma/ib_umem_odp.h>
 #include "mlx5_ib.h"
 #include <linux/jiffies.h>
+#include <linux/io.h>
 
 /*
  * Fill in a physical address list. ib_umem_num_dma_blocks() entries will be
@@ -148,7 +149,9 @@ static int post_send_nop(struct mlx5_ib_
 	 */
 	wmb();
 	memcpy_toio_64(bf->bfreg->map + bf->offset, mmio_wqe);
+#ifdef io_stop_wc
 	io_stop_wc();
+#endif
 
 	bf->offset ^= bf->buf_size;
 
@@ -216,7 +219,11 @@ int mlx5_ib_test_wc(struct mlx5_ib_dev *
 	if (!dev->mdev->roce.roce_en &&
 	    port_type_cap == MLX5_CAP_PORT_TYPE_ETH) {
 		if (mlx5_core_is_pf(dev->mdev))
+#ifdef arch_can_pci_mmap_wc
 			dev->wc_support = arch_can_pci_mmap_wc();
+#else
+			dev->wc_support = true;
+#endif
 		return 0;
 	}
 
