From: Lama Kayal <lkayal@nvidia.com>
Subject: [PATCH] BACKPORT:
 drivers/net/ethernet/mellanox/mlx5/core/diag/reporter_vnic.c

Change-Id: I7f9d3f59b38d525a26701472b20de7f2df32c133
---
 .../mellanox/mlx5/core/diag/reporter_vnic.c   | 20 +++++++++++++++----
 1 file changed, 16 insertions(+), 4 deletions(-)

--- a/drivers/net/ethernet/mellanox/mlx5/core/diag/reporter_vnic.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/diag/reporter_vnic.c
@@ -1,10 +1,12 @@
 // SPDX-License-Identifier: GPL-2.0 OR Linux-OpenIB
 /* Copyright (c) 2023, NVIDIA CORPORATION & AFFILIATES. */
 
+#ifdef HAVE_DEVLINK_HEALTH_REPORT_SUPPORT
 #include "reporter_vnic.h"
 #include "en_stats.h"
 #include "devlink.h"
 
+#ifdef HAVE_HEALTH_REPORTER_DIAGNOSE
 #define VNIC_ENV_GET64(vnic_env_stats, c) \
 	MLX5_GET64(query_vnic_env_out, (vnic_env_stats)->query_vnic_env_out, \
 		 vport_env.c)
@@ -116,17 +118,22 @@ int mlx5_reporter_vnic_diagnose_counters
 }
 
 static int mlx5_reporter_vnic_diagnose(struct devlink_health_reporter *reporter,
-				       struct devlink_fmsg *fmsg,
-				       struct netlink_ext_ack *extack)
+				       struct devlink_fmsg *fmsg
+#ifdef HAVE_HEALTH_REPORTER_RECOVER_HAS_EXTACK
+				       , struct netlink_ext_ack *extack
+#endif
+				       )
 {
 	struct mlx5_core_dev *dev = devlink_health_reporter_priv(reporter);
 
 	return mlx5_reporter_vnic_diagnose_counters(dev, fmsg, 0, false);
 }
-
+#endif /* HAVE_HEALTH_REPORTER_DIAGNOSE */
 static const struct devlink_health_reporter_ops mlx5_reporter_vnic_ops = {
 	.name = "vnic",
+#ifdef HAVE_HEALTH_REPORTER_DIAGNOSE
 	.diagnose = mlx5_reporter_vnic_diagnose,
+#endif
 };
 
 void mlx5_reporter_vnic_create(struct mlx5_core_dev *dev)
@@ -137,7 +144,11 @@ void mlx5_reporter_vnic_create(struct ml
 	health->vnic_reporter =
 		devlink_health_reporter_create(devlink,
 					       &mlx5_reporter_vnic_ops,
-					       0, dev);
+					       0,
+#ifdef HAVE_DEVLINK_HEALTH_REPORTER_CREATE_5_ARGS
+					       false,
+#endif
+					       dev);
 	if (IS_ERR(health->vnic_reporter))
 		mlx5_core_warn(dev,
 			       "Failed to create vnic reporter, err = %ld\n",
@@ -151,3 +162,4 @@ void mlx5_reporter_vnic_destroy(struct m
 	if (!IS_ERR_OR_NULL(health->vnic_reporter))
 		devlink_health_reporter_destroy(health->vnic_reporter);
 }
+#endif /* HAVE_DEVLINK_HEALTH_REPORT_SUPPORT */
