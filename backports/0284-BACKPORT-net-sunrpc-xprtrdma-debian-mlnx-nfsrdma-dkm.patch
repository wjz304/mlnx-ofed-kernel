From: Tom Wu <tomwu@nvidia.com>
Subject: [PATCH] BACKPORT:
 net/sunrpc/xprtrdma/debian/mlnx-nfsrdma-dkms.postinst

Change-Id: I0699a19916a419bf276635f57ca36f21847ecdd6
---
 .../debian/mlnx-nfsrdma-dkms.postinst         | 44 ++++++++++++++-----
 1 file changed, 34 insertions(+), 10 deletions(-)

--- a/net/sunrpc/xprtrdma/debian/mlnx-nfsrdma-dkms.postinst
+++ b/net/sunrpc/xprtrdma/debian/mlnx-nfsrdma-dkms.postinst
@@ -2,18 +2,42 @@
 set -e
 
 # Get the package version
-package=mlnx-nfsrdma
-version=`dpkg-query -W -f='${Version}' "$package-dkms" \
-    | sed -e 's/[+-].*//'`
-
-isadded=`dkms status -m "$name" -v "$version"`
-
-if [ "x${isadded}" = "x" ] ; then
-    dkms add -m "$package" -v "$version"
-fi
-
-if [ "$1" = 'configure' ] ; then
-    dkms build -m "$package" -v "$version" && dkms install -m "$package" -v "$version" --force || true
-fi
+NAME=mlnx-nfsrdma
+PACKAGE_NAME=$NAME-dkms
+CVERSION=`dpkg-query -W -f='${Version}' $PACKAGE_NAME | awk -F "-" '{print $1}' | cut -d\: -f2`
+ARCH=`uname -m`
+
+dkms_configure () {
+	POSTINST="/usr/src/$NAME-$CVERSION/common.postinst"
+	if [ -f "$POSTINST" ]; then
+		"$POSTINST" "$NAME" "$CVERSION" "/usr/share/$PACKAGE_NAME" "$ARCH" "$2"
+		return $?
+	fi
+	echo "WARNING: $POSTINST does not exist." >&2
+	echo "ERROR: DKMS version is too old and $PACKAGE_NAME was not" >&2
+	echo "built with legacy DKMS support." >&2
+	echo "You must either rebuild $PACKAGE_NAME with legacy postinst" >&2
+	echo "support or upgrade DKMS to a more current version." >&2
+	return 1
+}
+
+case "$1" in
+	configure)
+		dkms_configure
+	;;
+
+	abort-upgrade|abort-remove|abort-deconfigure)
+	;;
+
+	*)
+		echo "postinst called with unknown argument \`$1'" >&2
+		exit 1
+	;;
+esac
+
+# dh_installdeb will replace this with shell code automatically
+# generated by other debhelper scripts.
+
+#DEBHELPER#
 
 exit 0
